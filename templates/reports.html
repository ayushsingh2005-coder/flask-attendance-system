<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-chart-bar"></i> Attendance Reports
                </h1>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-table"></i> Student Attendance Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Roll Number</th>
                                        <th>Total Days</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                        <th>Late</th>
                                        <th>Attendance %</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="reportTableBody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Export Options -->
                        <div class="mt-4">
                            <h6>Export Options:</h6>
                            <button class="btn btn-outline-primary me-2" onclick="exportToCSV()" aria-label="Export to CSV">
                                <i class="fas fa-file-csv"></i> Export to CSV
                            </button>
                            <button class="btn btn-outline-success" onclick="printReport()" aria-label="Print Report">
                                <i class="fas fa-print"></i> Print Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Attendance Distribution</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="attendanceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Student Performance</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Sample data - replace this with actual data from your backend
        const reportData = [
            {
                student_name: "John Doe",
                roll_number: "2021001",
                total_days: 30,
                present_days: 25,
                absent_days: 3,
                late_days: 2,
                attendance_percentage: 83.3
            },
            {
                student_name: "Jane Smith",
                roll_number: "2021002",
                total_days: 30,
                present_days: 28,
                absent_days: 1,
                late_days: 1,
                attendance_percentage: 93.3
            },
            {
                student_name: "Mike Johnson",
                roll_number: "2021003",
                total_days: 30,
                present_days: 20,
                absent_days: 8,
                late_days: 2,
                attendance_percentage: 66.7
            },
            {
                student_name: "Sarah Wilson",
                roll_number: "2021004",
                total_days: 30,
                present_days: 27,
                absent_days: 2,
                late_days: 1,
                attendance_percentage: 90.0
            },
            {
                student_name: "David Brown",
                roll_number: "2021005",
                total_days: 30,
                present_days: 22,
                absent_days: 6,
                late_days: 2,
                attendance_percentage: 73.3
            }
        ];

        // Populate the table
        function populateTable() {
            const tableBody = document.getElementById('reportTableBody');
            tableBody.innerHTML = '';

            reportData.forEach(data => {
                const row = document.createElement('tr');
                
                // Determine status based on attendance percentage
                let statusBadge, statusText;
                if (data.attendance_percentage >= 75) {
                    statusBadge = 'bg-success';
                    statusText = 'Good';
                } else if (data.attendance_percentage >= 50) {
                    statusBadge = 'bg-warning';
                    statusText = 'Average';
                } else {
                    statusBadge = 'bg-danger';
                    statusText = 'Poor';
                }

                // Determine progress bar color
                let progressColor;
                if (data.attendance_percentage >= 75) {
                    progressColor = 'bg-success';
                } else if (data.attendance_percentage >= 50) {
                    progressColor = 'bg-warning';
                } else {
                    progressColor = 'bg-danger';
                }

                row.innerHTML = `
                    <td><i class="fas fa-user"></i> ${data.student_name}</td>
                    <td><span class="badge bg-secondary">${data.roll_number}</span></td>
                    <td>${data.total_days}</td>
                    <td><span class="badge bg-success">${data.present_days}</span></td>
                    <td><span class="badge bg-danger">${data.absent_days}</span></td>
                    <td><span class="badge bg-warning">${data.late_days}</span></td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${progressColor}" 
                                 role="progressbar" 
                                 style="width: ${data.attendance_percentage}%">
                                ${data.attendance_percentage}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${statusBadge}">${statusText}</span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Initialize charts and table
        function initializeCharts() {
            // Attendance Distribution Pie Chart
            const ctx1 = document.getElementById('attendanceChart').getContext('2d');
            const totalPresent = reportData.reduce((sum, data) => sum + data.present_days, 0);
            const totalAbsent = reportData.reduce((sum, data) => sum + data.absent_days, 0);
            const totalLate = reportData.reduce((sum, data) => sum + data.late_days, 0);

            new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: ['Present', 'Absent', 'Late'],
                    datasets: [{
                        data: [totalPresent, totalAbsent, totalLate],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = totalPresent + totalAbsent + totalLate;
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Student Performance Bar Chart
            const ctx2 = document.getElementById('performanceChart').getContext('2d');
            const studentNames = reportData.map(data => data.student_name.split(' ')[0]);
            const attendancePercentages = reportData.map(data => data.attendance_percentage);

            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: studentNames,
                    datasets: [{
                        label: 'Attendance %',
                        data: attendancePercentages,
                        backgroundColor: attendancePercentages.map(percentage => {
                            if (percentage >= 75) return '#28a745';
                            else if (percentage >= 50) return '#ffc107';
                            else return '#dc3545';
                        }),
                        borderWidth: 1,
                        borderColor: attendancePercentages.map(percentage => {
                            if (percentage >= 75) return '#1e7e34';
                            else if (percentage >= 50) return '#d39e00';
                            else return '#bd2130';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Attendance: ${context.parsed.y}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Export to CSV
        function exportToCSV() {
            let csv = 'Student Name,Roll Number,Total Days,Present,Absent,Late,Attendance %\n';
            reportData.forEach(function(data) {
                csv += `"${data.student_name}","${data.roll_number}",${data.total_days},${data.present_days},${data.absent_days},${data.late_days},${data.attendance_percentage}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Print Report
        function printReport() {
            window.print();
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            populateTable();
            initializeCharts();
        });

        // Add some CSS for print styling
        const style = document.createElement('style');
        style.textContent = `
            @media print {
                .btn { display: none !important; }
                .card { border: 1px solid #000 !important; }
                .progress { 
                    border: 1px solid #000 !important;
                    background-color: #f8f9fa !important;
                }
            }
            
            .progress {
                background-color: #e9ecef;
            }
            
            .card {
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
                margin-bottom: 1rem;
            }
            
            .badge {
                font-size: 0.75em;
            }
            
            canvas {
                max-height: 300px;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>